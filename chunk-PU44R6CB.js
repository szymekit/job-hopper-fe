import{a as d}from"./chunk-FT2GGG6N.js";import{a as g}from"./chunk-LIPKMQYY.js";import{b as h}from"./chunk-G6XE52Q4.js";import{$ as r,W as p,i as c,na as l,q as n,y as i}from"./chunk-6R5FC44M.js";var m=class o{authService=r(d);notifications=r(g);ws=null;messagesSubject=new c;connected=l(!1);reconnectAttempts=0;maxReconnectAttempts=5;reconnectTimeout=null;connected$=this.connected.asReadonly();connect(){if(this.ws?.readyState===WebSocket.OPEN)return;let e=this.authService.getToken();if(!e)return;let t=`${h}?token=${e}`;this.ws=new WebSocket(t),this.ws.onopen=()=>{this.connected.set(!0),this.reconnectAttempts>0&&this.notifications.showInfo("Po\u0142\u0105czenie z czatem zosta\u0142o przywr\xF3cone."),this.reconnectAttempts=0},this.ws.onmessage=s=>{try{let a=JSON.parse(s.data);this.messagesSubject.next(a)}catch(a){console.error("Failed to parse WebSocket message:",a)}},this.ws.onerror=s=>{console.error("WebSocket error:",s),this.connected.set(!1)},this.ws.onclose=s=>{this.connected.set(!1),s.code!==1e3&&(this.reconnectAttempts++,this.reconnectAttempts===1&&this.notifications.showWarning("Po\u0142\u0105czenie z czatem zosta\u0142o utracone. Pr\xF3ba ponownego po\u0142\u0105czenia..."),this.attemptReconnect())}}disconnect(){this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null),this.ws&&(this.ws.close(),this.ws=null),this.connected.set(!1)}attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts)return;this.reconnectAttempts++;let e=Math.min(1e3*Math.pow(2,this.reconnectAttempts),3e4);this.reconnectTimeout=setTimeout(()=>{this.authService.isAuthenticated()&&this.connect()},e)}sendMessage(e,t){!this.ws||this.ws.readyState!==WebSocket.OPEN||this.ws.send(JSON.stringify({type:"message",payload:{conversationId:e,content:t}}))}sendTyping(e,t){!this.ws||this.ws.readyState!==WebSocket.OPEN||this.ws.send(JSON.stringify({type:"typing",payload:{conversationId:e,isTyping:t}}))}onMessage(){return this.messagesSubject.pipe(i(e=>e.type==="message"),n(e=>e.payload))}onTyping(){return this.messagesSubject.pipe(i(e=>e.type==="typing"),n(e=>e.payload))}onPresence(){return this.messagesSubject.pipe(i(e=>e.type==="presence"),n(e=>e.payload))}onNotification(){return this.messagesSubject.pipe(i(e=>e.type==="notification"),n(e=>e.payload))}static \u0275fac=function(t){return new(t||o)};static \u0275prov=p({token:o,factory:o.\u0275fac,providedIn:"root"})};export{m as a};
