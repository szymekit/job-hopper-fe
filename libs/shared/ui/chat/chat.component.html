@if (isOpen()) {
  <div class="chat">
    <div class="chat__header">
      <div class="chat__header-user">
        @if (activeConversation()) {
          <img
            class="chat__header-avatar"
            [src]="activeConversation()!.participant.avatarUrl"
            [alt]="activeConversation()!.participant.name"
          />
          <span class="chat__header-name">{{ activeConversation()!.participant.name }}</span>
        }
      </div>
      <button class="chat__close-btn" (click)="close()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="chat__content">
      <div class="chat__conversations">
        <div class="chat__conversations-header">Konwersacje</div>
        <div class="chat__conversations-list">
          @for (conversation of conversations(); track conversation.id) {
            <button
              class="chat__conversation"
              [class.chat__conversation--active]="data().activeConversationId === conversation.id"
              (click)="selectConversation(conversation.id)"
            >
              <img
                class="chat__conversation-avatar"
                [src]="conversation.participant.avatarUrl"
                [alt]="conversation.participant.name"
              />
              <div class="chat__conversation-info">
                <div class="chat__conversation-name">{{ conversation.participant.name }}</div>
                <div class="chat__conversation-preview">
                  @if (conversation.messages.length > 0) {
                    {{ conversation.messages[conversation.messages.length - 1].content | slice : 0 : 30
                    }}...
                  }
                </div>
              </div>
              <div class="chat__conversation-meta">
                <span class="chat__conversation-time">{{ conversation.lastMessageTime }}</span>
                @if (conversation.unreadCount > 0) {
                  <span class="chat__conversation-badge">{{ conversation.unreadCount }}</span>
                }
              </div>
              @if (conversation.participant.isActive) {
                <div class="chat__conversation-indicator"></div>
              }
            </button>
          }
        </div>
      </div>

      <div class="chat__main">
        <div class="chat__messages" #messagesContainer>
          @for (message of activeMessages(); track message.id) {
            <div
              class="chat__message"
              [class.chat__message--own]="message.isOwn"
            >
              <div class="chat__message-bubble">
                <p class="chat__message-content">{{ message.content }}</p>
                @if (message.timestamp) {
                  <span class="chat__message-time">{{ message.timestamp }}</span>
                }
              </div>
            </div>
          }
        </div>

        <div class="chat__input-wrapper">
          <input
            #messageInput
            type="text"
            class="chat__input"
            [formControl]="messageForm"
            placeholder="Napisz wiadomość..."
            (keydown.enter)="sendMessage()"
          />
          <button class="chat__send-btn" (click)="sendMessage()" [disabled]="!messageForm.valid">
            <mat-icon>send</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </div>
} @else {
  <button class="chat__bubble" (click)="toggle()">
    <mat-icon>chat</mat-icon>
  </button>
}
